name: Test Notify

on:
  repository_dispatch:
    types: [test-notify]

jobs:
  echo-dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Format Slack message
        id: format
        run: |
          REQUIRED_ACTION_TYPE="${{ github.event.client_payload.required_action_type}" }}"
          AUTHOR="${{ github.event.client_payload.author }}"
          PR_NUMBER="${{ github.event.client_payload.pull_request.number }}"
          PR_TITLE="${{ github.event.client_payload.pull_request.title }}"
          PR_URL="${{ github.event.client_payload.pull_request.html_url }}"

          # é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆï¼ˆå¿…è¦ãªã‚‰switchçš„ã«å‡ºã—åˆ†ã‘ã¦ã‚‚OKï¼‰
          case "$REQUIRED_ACTION_TYPE" in
            auto-create-pr-merge)
              EMOJI="â˜‘ï¸"
              MESSAGE="*${PR_TITLE}* ã®PRãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼ˆãƒãƒ¼ã‚¸å¯¾å¿œãŒå¿…è¦ã§ã™ï¼‰"
              ;;
            auto-create-pr-conflict)
              EMOJI="âš¡"
              MESSAGE="*${PR_TITLE}* ã«ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ï¼ˆå¯¾å¿œãŒå¿…è¦ã§ã™ï¼‰"
              ;;
            auto-create-pr-fail-ci)
              EMOJI="âŒ"
              MESSAGE="*${PR_TITLE}* ã®CIãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆä¿®æ­£ãŒå¿…è¦ã§ã™ï¼‰"
              ;;
            *)
              EMOJI="â„¹ï¸"
              MESSAGE="é€šçŸ¥ã‚¿ã‚¤ãƒ—: ${REQUIRED_ACTION_TYPE} ã®PRé€šçŸ¥ã§ã™"
              ;;
          esac

          BODY=$(cat <<EOF
          ${EMOJI} ${MESSAGE}
          
          ğŸ”— <${PR_URL}|#${PR_NUMBER}> by @${AUTHOR}
          EOF
          )

          ESCAPED_BODY="${BODY//$'\n'/\\n}"
          echo "payload={\"text\":\"${ESCAPED_BODY}\"}" >> $GITHUB_OUTPUT

      - name: Send to Slack
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: ${{ steps.format.outputs.payload }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_TANUKI_BOX_WEBHOOK_URL }}